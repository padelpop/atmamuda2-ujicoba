<?php
require_once 'database/db.php';

// Ambil info pengunjung
$ip = $_SERVER['REMOTE_ADDR'];
$agent = $_SERVER['HTTP_USER_AGENT'];

// Simpan sebagai kunjungan
$stmt = $pdo->prepare("INSERT INTO visitors (ip_addres, user_agent) VALUES (?, ?)");
$stmt->execute([$ip, $agent]);

// Total kunjungan
$stmt = $pdo->query("SELECT COUNT(*) FROM visitors");
$totalVisitor = $stmt->fetchColumn();

// Get settings
$stmt = $pdo->query("SELECT * FROM setting");
$setting = [];
while ($row = $stmt->fetch()) {
    $setting[$row['setting_key']] = $row['setting_value'];
}

// Get kegiatan
$stmt = $pdo->query("SELECT * FROM kegiatan ORDER BY tanggal DESC LIMIT 4");
$kegiatanList = $stmt->fetchAll();

// Get galeri
$stmt = $pdo->query("SELECT * FROM galeri ORDER BY created_at DESC LIMIT 7");
$galeriList = $stmt->fetchAll();

// Get struktur
$stmt = $pdo->query("SELECT * FROM struktur ORDER BY urutan ASC");
$strukturList = $stmt->fetchAll();

// Group struktur by jabatan
$strukturByJabatan = [];
foreach ($strukturList as $anggota) {
    $strukturByJabatan[$anggota['jabatan']][] = $anggota;
}
?>
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= $setting['site_title'] ?? 'Karang Taruna' ?></title>
    <link rel="stylesheet" href="style-news.css">
    <link rel="stylesheet" href="responsif.css">
</head>
<body>

    <!-- Navbar -->
    <header class="site-header">
    <div class="container header-inner">
        <a class="brand" href="#">
            <img src="uploads/logokt.png" class="header-logo" alt="Logo">
        </a>

        <!-- Hamburger menu -->
        <div class="hamburger" onclick="toggleMenu()">
            <span></span>
            <span></span>
            <span></span>
        </div>

        <nav class="nav-menu" id="nav-menu">
            <ul>
                <li><a href="#beranda">Beranda</a></li>
                <li><a href="#tentang">Tentang</a></li>
                <li><a href="#struktur">Struktur</a></li>
                <li><a href="#kegiatan">Kegiatan</a></li>
                <li><a href="#galeri">Galeri</a></li>
                <div class="nav-visitor">
                    <span class="visitor-icon">üëÅ</span>
                    <span class="visitor-count"><?= number_format($totalVisitor) ?></span>
                </div>
            </ul>
        </nav>
    </div>
    </header>
    
    <!-- Hero Section -->
    <section id="beranda" class="hero-section" style="background-image: url('uploads/IMG_7646.jpg');">
        <div class="hero-content">
           <h1 class="hero-title"><?= htmlspecialchars($setting['site_title'] ?? 'Karang Taruna Atma Muda Nawasena') ?></h1>
           <p class="hero-subtitle"><?= htmlspecialchars($setting['site_subtitle'] ?? 'Muda Berkarya, Maju Bersama') ?></p>
        </div>
    </section>

    <!-- Tentang Kami -->
    <section id="tentang" class="tentang-section">
        <div class="tentang-container">
            
            <!-- Gambar -->
            <div class="tentang-img">
                <img src="uploads/logokt.png" alt="Tentang Kami">
            </div>

            <!-- Teks -->
           <div class="tentang-text animate-on-scroll">
        <h2>Tentang Kami</h2>
        <p>
          Karang Taruna Atma Muda Nawasena adalah organisasi sosial kepemudaan yang berkomitmen untuk
          menjadi wadah pengembangan generasi muda dalam berbagai aspek, termasuk sosial, ekonomi, dan budaya. 
        </p>
        <p>
          Karang Taruna Atma Muda Nawasena juga memiliki misi utama untuk menciptakan pemuda yang mandiri, kreatif,
          serta memiliki kontribusi nyata dalam pembangunan lingkungan dukuh Rejosari.
        </p>
        <a href="#kegiatan" class="btn-biru">Lihat Kegiatan Kami</a>
      </div>
        </div>
    </section>

    <!-- Struktur -->
    <main class="content" id="struktur">
        <h2 class="title">Struktur Organisasi</h2>

        <div class="org-structure">

            <?php foreach ($strukturByJabatan as $jabatan => $members): ?>
            <!-- <?= $jabatan ?> -->
            <div class="position-group">
                <h3><?= $jabatan ?></h3>
                <div class="members-row">
                    <?php foreach ($members as $member): ?>
                    <div class="member-card">
                        <div class="member-photo">
                            <img src="uploads/<?= $member['foto'] ?>" alt="<?= $member['nama'] ?>">
                        </div>
                        <p class="member-name"><?= $member['nama'] ?></p>
                        <?php if ($member['sub_jabatan']): ?>
                            <p class="member-role"><?= $member['sub_jabatan'] ?></p>
                        <?php endif; ?>
                    </div>
                    <?php endforeach; ?>
                </div>
            </div>
            <?php endforeach; ?>

        </div>
    </main>

    <!-- Kegiatan -->
    <section class="section-kegiatan" id="kegiatan">
        <h2>Kegiatan Terbaru</h2>

        <div class="kegiatan-wrapper">
            <?php foreach ($kegiatanList as $kegiatan): ?>
            <div class="kegiatan-card">
                <?php if ($kegiatan['foto']): ?>
                    <img src="uploads/<?= $kegiatan['foto'] ?>" alt="<?= $kegiatan['judul'] ?>">
                <?php else: ?>
                    <img src="uploads/placeholder.jpg" alt="<?= $kegiatan['judul'] ?>">
                <?php endif; ?>
                <div class="kegiatan-content">
                    <div class="kegiatan-title"><?= $kegiatan['judul'] ?></div>
                    <div class="kegiatan-date"><?= date('d F Y', strtotime($kegiatan['tanggal'])) ?></div>
                </div>
            </div>
            <?php endforeach; ?>
        </div>
    </section>

    <!-- Galeri -->
    <section class="section-galeri" id="galeri">
        <h2>Galeri Foto Terbaru</h2>

        <div class="galeri">
            <?php foreach ($galeriList as $galeri): ?>
                <div class="galeri-item">
                    <a href="<?= $galeri['link'] ?: '#' ?>" target="_blank">
                        <img src="uploads/<?= $galeri['foto'] ?>" alt="<?= $galeri['judul'] ?>">
                    </a>
                    <a class="judul-foto" href="<?= $galeri['link'] ?: '#' ?>" target="_blank">
                        <?= $galeri['judul'] ?>
                    </a>
                </div>
            <?php endforeach; ?>
        </div>

        <div class="button-wrapper">
            <button id="lihatSelengkapnyaBtn">
                Lihat Selengkapnya
            </button>
        </div>
</section>


    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">

            <!-- Logo kiri -->
            <div class="footer-logo">
                <img src="uploads/logokt.png" alt="Logo Karang Taruna">
                
                <div class="footer-text">
                    <span>Karang Taruna</span>
                    <span>Atma Muda Nawasena</span>
                </div> 
            </div>

            <!-- Hubungi -->
            <div class="footer-contact">
                <h4>KONTAK</h4>
                <p><span class="icon">üìß</span>
                    <?= htmlspecialchars($setting['contact_email'] ?? 'ktrejosari123@gmail.com') ?>
                </p>

                <p><span class="icon">üì±</span>
                    <a class="contact-link"
                    href="https://www.instagram.com/kt.atmamudanawasena?igsh=MWFwOW9qZmpsa2JsZQ==" target ="_blank">
                    <?= htmlspecialchars($setting['contact_instagram'] ?? '@kt.atmamudanawasena') ?>
                    </a>
                </p>

                <p><span class="icon">üìç</span>
                    <?= htmlspecialchars($setting['contact_address'] ?? 'Jl. Raya Solo-Jogja Km.15, Rejosari, Bendosari, Sawit, Boyolali, 57374') ?>
                </p>
            </div>

        </div>

        <hr>

        <p class="footer-copy">
           ¬© <?= date('Y') ?> <?= htmlspecialchars($setting['site_title'] ?? 'Karang Taruna Atma Muda Nawasena') ?> | All Rights Reserved
        </p>
    </footer>

    <script>
        // Smooth scroll animation
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Add fade-in animation on scroll
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -100px 0px'
        };

        const observer = new IntersectionObserver(function(entries) {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('fade-in');
                }
            });
        }, observerOptions);

        document.querySelectorAll('.tentang-section, .content, .section-kegiatan, .section').forEach(el => {
            observer.observe(el);
        });

        // Header shadow on scroll
        window.addEventListener('scroll', function() {
            const header = document.querySelector('.header');
            if (window.scrollY > 100) {
                header.style.boxShadow = '0 4px 30px rgba(0, 0, 0, 0.2)';
            } else {
                header.style.boxShadow = '0 2px 20px rgba(0, 0, 0, 0.1)';
            }
        });
    </script>

<script>
function toggleMenu() {
    const hamburger = document.querySelector('.hamburger');
    const navMenu = document.querySelector('.nav-menu');

    hamburger.addEventListener('click', () => {
        navMenu.classList.toggle('show');
    });
}
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const items = document.querySelectorAll(".galeri-item");
  const btn = document.getElementById("lihatSelengkapnyaBtn");

  // Tentukan batas awal
  const limit = window.innerWidth <= 768 ? 2 : 3;
  let expanded = false;

  // Jika total foto <= limit, tombol tidak perlu muncul
  if (items.length <= limit) {
    btn.style.display = "none";
    return;
  }

  // Sembunyikan foto setelah batas awal
  function applyLimit() {
    items.forEach((item, index) => {
      if (index < limit) {
        item.style.display = "block";
      } else {
        item.style.display = expanded ? "block" : "none";
      }
    });

    btn.textContent = expanded ? "Lihat Lebih Sedikit" : "Lihat Selengkapnya";
  }

  // Jalankan saat awal
  applyLimit();

  // Event tombol
  btn.addEventListener("click", () => {
    expanded = !expanded;
    applyLimit();
  });

});
</script>


</body>
</html>
